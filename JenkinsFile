pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'bank-management-system'
        DOCKER_TAG = "${env.BUILD_ID}"
    }

    stages {
        stage('Workspace Cleanup') {
            steps {
                cleanWs()
                echo 'Cleaning workspace...'
            }
        }

        stage('Checkout Git Branch') {
            steps {
                checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-credentials', url: 'https://github.com/RutujaBangera/BankManagementSystem.git']])
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Assuming your Dockerfile and docker-compose.yml are in the root of the checked-out repository
                    sh 'docker compose up --build -d'
                }
                echo 'Docker image built and services started successfully!'
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    sh '''
                        docker run --rm --name test-container ${DOCKER_IMAGE}:${DOCKER_TAG} pytest --junitxml=test-results.xml
                    '''
                    sh 'docker cp test-container:/app/test-results.xml .'
                }
                echo 'Tests completed!'
            }
            post {
                success {
                    echo 'Tests passed successfully!'
                }
                failure {
                    echo 'Tests failed! Check test-results.xml for details.'
                }
            }
        }

        stage('Deploy to Test Environment') {
            steps {
                echo 'No explicit deployment step needed as services are already running from the "Build Docker Image" stage.'
                echo 'If further deployment steps are required, add them here.'
                // If you need to manage the running containers (e.g., restart, scale), you can use docker compose commands here.
                // Example: sh 'docker compose restart'
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution completed.'
            archiveArtifacts artifacts: 'test-results.xml', fingerprint: true, allowEmptyArchive: true
        }
        success {
            echo 'Pipeline succeeded! Application is deployed and running.'
        }
        failure {
            echo 'Pipeline failed! Check the logs for details.'
        }
    }
}
